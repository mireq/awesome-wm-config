#!/usr/bin/env python3
from subprocess import check_output
import re


SCREEN_RE = re.compile(r'^Screen (?P<screen>\d+):.*$')
OUTPUT_RE = re.compile(r'^(?P<name>[a-zA-Z0-9\-]+) (?P<connected>connected|disconnected).*$')


def parse_output(output):
	property_name = None
	property_value = ''
	property_info = []
	properties = {}

	for line in output:
		if line.startswith('\t\t'):
			property_info.append(line.strip())
		elif line.startswith('\t'):
			try:
				if property_name is not None:
					properties[property_name] = {
						'value': property_value,
						'info': property_info,
					}
					property_value = ''
					property_info = []
				property_name, property_value = line.split(':', 1)
				property_name = property_name.strip()
				property_value = property_value.strip()
			except ValueError:
				property_name = line.strip()
		elif line.startswith('   '): # mode
			print(line)
	
	if property_name is not None:
		properties[property_name] = {
			'value': property_value,
			'info': property_info,
		}
		property_value = ''
		property_info = []

	return {
		'properties': properties,
	}

def parse_outputs(output):
	outputs = {}
	current_output = None
	current_output_lines = []

	for line in output:
		match = OUTPUT_RE.match(line)
		if match is not None:
			if current_output is not None:
				output = parse_output(current_output_lines)
				output['connected'] = current_output['connected'] == 'connected'
				outputs[current_output['name']] = output
			current_output = match.groupdict()
			current_output_lines = []
		else:
			current_output_lines.append(line)
	if current_output is not None:
		output = parse_output(current_output_lines)
		output['connected'] = current_output['connected'] == 'connected'
		outputs[current_output['name']] = output
	return outputs


def parse_screens(output):
	screens = {}
	current_screen = None
	current_screen_lines = []
	for line in output:
		match = SCREEN_RE.match(line)
		if match is not None:
			if current_screen is not None:
				outputs = parse_outputs(current_screen_lines)
				screens[current_screen] = outputs
			current_screen = match.groupdict()['screen']
			current_screen_lines = []
		else:
			current_screen_lines.append(line)
	if current_screen is not None:
		outputs = parse_outputs(current_screen_lines)
		screens[current_screen] = outputs
	return screens


def parse_xrandr(output):
	__import__('pprint').pprint(parse_screens(output))


def main():
	xrandr_output = check_output(["xrandr", '--properties']).decode("utf-8")
	parse_xrandr(xrandr_output.splitlines())


if __name__ == "__main__":
	main()
